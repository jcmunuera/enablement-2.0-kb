# ═══════════════════════════════════════════════════════════════════════════════
# CAPABILITY INDEX v2.2
# ═══════════════════════════════════════════════════════════════════════════════
# 
# Single source of truth for capability → feature → implementation → module
# 
# Changes from v2.1:
#   - New capability types: foundational, layered, cross-cutting
#   - Added phase_group for automatic phase assignment
#   - Added cardinality (exactly-one, multiple)
#   - Added default_feature for capability-level matches
#   - Feature requires now points to capability (not specific feature)
#   - New feature: api-architecture.standard as default
#
# ═══════════════════════════════════════════════════════════════════════════════
# CAPABILITY TYPES
# ═══════════════════════════════════════════════════════════════════════════════
#
# type: foundational | layered | cross-cutting
#
#   FOUNDATIONAL:
#     - Defines base architecture (exactly one required for flow-generate)
#     - Cannot be transformed (must be set at project creation)
#     - Example: architecture
#
#   LAYERED:
#     - Adds architectural layers on top of foundational
#     - Requires foundational to exist
#     - Can be added via transformation
#     - Examples: api-architecture, persistence, integration
#
#   CROSS-CUTTING:
#     - Decorators that apply to existing code
#     - Does NOT require foundational (can apply to existing projects)
#     - Examples: resilience, distributed-transactions
#
# ═══════════════════════════════════════════════════════════════════════════════
# PHASE GROUPS
# ═══════════════════════════════════════════════════════════════════════════════
#
# phase_group determines execution phase:
#
#   structural     → Phase 1 (project structure, adapters IN)
#   implementation → Phase 2 (connect to external systems, adapters OUT)
#   cross-cutting  → Phase 3+ (decorators, annotations)
#
# ═══════════════════════════════════════════════════════════════════════════════
# DISCOVERY RULES
# ═══════════════════════════════════════════════════════════════════════════════
#
# Rule 1: Keyword matching priority
#   feature.keywords > capability.keywords
#
# Rule 2: Default feature resolution
#   If capability matched but no feature → use default_feature
#   If no default_feature → ask user to choose
#
# Rule 3: Dependency resolution
#   requires: [capability] → auto-add capability.default_feature if not present
#
# Rule 4: Foundational guarantee (flow-generate only)
#   Exactly ONE foundational required
#   If missing → auto-add architecture.hexagonal-light
#
# Rule 5: Incompatibility check
#   Check incompatible_with before finalizing
#
# Rule 6: Phase assignment
#   Group features by phase_group attribute
#
# ═══════════════════════════════════════════════════════════════════════════════

version: "2.2"
domain: code
last_updated: "2026-01-21"

# ═══════════════════════════════════════════════════════════════════════════════
# ORGANIZATIONAL DEFAULTS
# ═══════════════════════════════════════════════════════════════════════════════

defaults:
  # Default technology stack when not specified or detected
  stack: java-spring
  
  # Default patterns when alternatives exist
  patterns:
    timeout: annotation  # vs client-config

# ═══════════════════════════════════════════════════════════════════════════════
# SUPPORTED STACKS
# ═══════════════════════════════════════════════════════════════════════════════

stacks:
  java-spring:
    description: "Java 17+ with Spring Boot 3.x"
    detection:
      - file: pom.xml
        contains: "spring-boot-starter"
    keywords:
      - java
      - spring
      - spring boot
      - springboot
    
  java-quarkus:
    description: "Java 17+ with Quarkus"
    detection:
      - file: pom.xml
        contains: "quarkus"
    keywords:
      - java
      - quarkus
    
  nodejs:
    description: "Node.js with Express/Fastify"
    detection:
      - file: package.json
    keywords:
      - node
      - nodejs
      - javascript
      - typescript

# ═══════════════════════════════════════════════════════════════════════════════
# CAPABILITIES
# ═══════════════════════════════════════════════════════════════════════════════

capabilities:

  # ─────────────────────────────────────────────────────────────────────────────
  # ARCHITECTURE (foundational)
  # Base architecture - exactly one required for flow-generate
  # ─────────────────────────────────────────────────────────────────────────────
  architecture:
    description: "Foundational architectural patterns that define code structure"
    type: foundational
    phase_group: structural
    cardinality: exactly-one
    transformable: false
    documentation: "model/domains/code/capabilities/architecture.md"
    
    keywords:
      - microservicio
      - microservice
      - servicio
      - service
      - aplicación
      - application
      - backend
      - proyecto
      - project
    
    default_feature: hexagonal-light
    
    features:
      hexagonal-light:
        description: "Hexagonal Light architecture with domain, application, infrastructure layers"
        is_default: true
        keywords:
          - hexagonal
          - hexagonal architecture
          - clean architecture
          - ports and adapters
          - DDD
          - domain driven design
          - arquitectura hexagonal
        
        implementations:
          - id: java-spring
            module: mod-code-015-hexagonal-base-java-spring
            stack: java-spring
        
        default: java-spring

      # Future feature:
      # hexagonal-full:
      #   description: "Full Hexagonal architecture with CQRS/ES"
      #   is_default: false
      #   keywords: [hexagonal full, CQRS, event sourcing]

  # ─────────────────────────────────────────────────────────────────────────────
  # API-ARCHITECTURE (layered)
  # Defines how the service exposes its capabilities
  # ─────────────────────────────────────────────────────────────────────────────
  api-architecture:
    description: "API types according to Fusion 4-layer model"
    type: layered
    phase_group: structural
    cardinality: multiple
    transformable: true
    documentation: "model/domains/code/capabilities/api_architecture.md"
    
    keywords:
      - API
      - REST
      - REST API
      - Fusion
      - endpoint
      - exponer
      - expose
    
    # Default when user says just "API" without specifying type
    default_feature: standard
    
    features:
      # Standard API (default) - when user doesn't specify type from Fusion model
      standard:
        description: "Standard REST API - default when no specific Fusion type requested"
        is_default: true
        keywords:
          - API estándar
          - standard API
          - REST básico
          - basic REST
        
        requires:
          - architecture  # Points to capability, resolver uses default_feature
        
        config:
          hateoas: false
          compensation_available: false
        
        input_spec:
          serviceName:
            type: string
            required: true
            pattern: "^[a-z][a-z0-9-]*$"
            description: "Service name in kebab-case"
            example: "product-api"
          basePackage:
            type: string
            required: true
            pattern: "^[a-z][a-z0-9]*(\\.[a-z][a-z0-9]*)*$"
            description: "Java base package"
            example: "com.company.product"
          entities:
            type: array
            required: true
            description: "Domain entities to generate"
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

      # Fusion Domain API - exposes business capabilities as product
      domain-api:
        description: "Domain API - exposes business capabilities (Fusion model)"
        is_default: false
        keywords:
          - Domain API
          - API de dominio
          - Fusion Domain
          - business API
          - capacidades de negocio
          - API de negocio
          - producto API
        
        requires:
          - architecture  # Points to capability
        
        config:
          hateoas: true
          compensation_available: true
          transactional: true
          idempotent: true
        
        constraints:
          - "Must not call other Domain APIs directly"
          - "Should call System APIs for backend integration"
        
        input_spec:
          serviceName:
            type: string
            required: true
            pattern: "^[a-z][a-z0-9-]*$"
            description: "Service name in kebab-case"
            example: "customer-api"
          basePackage:
            type: string
            required: true
            pattern: "^[a-z][a-z0-9]*(\\.[a-z][a-z0-9]*)*$"
            description: "Java base package"
            example: "com.company.customer"
          entities:
            type: array
            required: true
            description: "Domain entities to generate"
            items:
              type: object
              properties:
                name: { type: string }
                fields: { type: array }
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

      system-api:
        description: "System API - wrapper over legacy systems"
        is_default: false
        keywords:
          - System API
          - API de sistema
          - Fusion System
          - wrapper
          - mainframe
          - legacy
          - CICS
        
        requires:
          - architecture  # Points to capability
        
        config:
          hateoas: false
          compensation_available: false
        
        input_spec:
          serviceName:
            type: string
            required: true
          basePackage:
            type: string
            required: true
          backendSpec:
            type: object
            required: true
            description: "OpenAPI spec of backend system"
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

      experience-api:
        description: "Experience API - BFF for UI channels"
        is_default: false
        keywords:
          - Experience API
          - Fusion Experience
          - BFF
          - Backend for Frontend
          - mobile
          - web
          - canal
        
        requires:
          - architecture  # Points to capability
        
        config:
          hateoas: true
          compensation_available: false
        
        input_spec:
          serviceName:
            type: string
            required: true
          basePackage:
            type: string
            required: true
          channel:
            type: string
            enum: [mobile, web, all]
            default: all
          downstreamApis:
            type: array
            description: "Downstream APIs to orchestrate"
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

      composable-api:
        description: "Composable API - multi-domain orchestration"
        is_default: false
        keywords:
          - Composable API
          - Fusion Composable
          - orchestration
          - orquestación
          - multi-domain
        
        requires:
          - architecture  # Points to capability
        
        config:
          hateoas: false
          compensation_available: false
        
        input_spec:
          serviceName:
            type: string
            required: true
          basePackage:
            type: string
            required: true
          orchestration:
            type: object
            description: "Orchestration definition"
        
        implementations:
          - id: java-spring
            module: mod-code-019-api-public-exposure-java-spring
            stack: java-spring
        
        default: java-spring

  # ─────────────────────────────────────────────────────────────────────────────
  # INTEGRATION (layered)
  # Patterns for integrating with external systems (adapters OUT)
  # ─────────────────────────────────────────────────────────────────────────────
  integration:
    description: "Patterns for integrating with external systems"
    type: layered
    phase_group: implementation
    cardinality: multiple
    transformable: true
    documentation: "model/domains/code/capabilities/integration.md"
    
    keywords:
      - integration
      - integración
      - external API
      - API externa
      - consumir API
    
    default_feature: api-rest
    
    features:
      api-rest:
        description: "Synchronous REST integration with RestClient"
        is_default: true
        keywords:
          - REST client
          - HTTP client
          - RestClient
          - integración REST
          - API client
          - consumir API
        
        requires:
          - architecture  # Points to capability
        
        implementations:
          - id: java-spring-restclient
            module: mod-code-018-api-integration-rest-java-spring
            stack: java-spring
            description: "Spring RestClient (synchronous)"
        
        default: java-spring-restclient

      # Future features:
      # api-grpc:
      #   description: "gRPC integration"
      #   keywords: [gRPC, protobuf, RPC]
      # event-kafka:
      #   description: "Kafka event integration"
      #   keywords: [Kafka, events, event-driven]

  # ─────────────────────────────────────────────────────────────────────────────
  # PERSISTENCE (layered)
  # Data persistence strategies (adapters OUT)
  # ─────────────────────────────────────────────────────────────────────────────
  persistence:
    description: "Data persistence strategies"
    type: layered
    phase_group: implementation
    cardinality: multiple
    transformable: true
    documentation: "model/domains/code/capabilities/persistence.md"
    
    keywords:
      - persistence
      - persistencia
      - data
      - datos
      - storage
      - database
      - base de datos
    
    # NO default_feature - user must choose between jpa and systemapi
    
    features:
      jpa:
        description: "JPA/Hibernate persistence with relational database"
        is_default: false
        keywords:
          - JPA
          - Hibernate
          - database
          - SQL
          - relational
          - ORM
          - entity
          - repository
        
        requires:
          - architecture  # Points to capability
        
        incompatible_with:
          - persistence.systemapi
        
        implementations:
          - id: java-spring
            module: mod-code-016-persistence-jpa-spring
            stack: java-spring
        
        default: java-spring

      systemapi:
        description: "Persistence delegated to System API (legacy backend)"
        is_default: false
        keywords:
          - System API
          - backend
          - legacy
          - mainframe
          - CICS
          - host
        
        requires:
          - architecture  # Points to capability
          - integration.api-rest  # Specific dependency
        
        incompatible_with:
          - persistence.jpa
        
        implementations:
          - id: java-spring
            module: mod-code-017-persistence-systemapi
            stack: java-spring
        
        default: java-spring

  # ─────────────────────────────────────────────────────────────────────────────
  # RESILIENCE (cross-cutting)
  # Decorators for fault tolerance - apply to existing code
  # ─────────────────────────────────────────────────────────────────────────────
  resilience:
    description: "Fault tolerance and resilience patterns"
    type: cross-cutting
    phase_group: cross-cutting
    cardinality: multiple
    transformable: true
    documentation: "model/domains/code/capabilities/resilience.md"
    
    keywords:
      - resilience
      - resiliencia
      - fault tolerance
      - tolerancia a fallos
      - stability patterns
      - patrones de estabilidad
    
    # NO default_feature - user must specify which patterns
    # NO requires foundational - can apply to existing code (flow-transform)
    
    features:
      circuit-breaker:
        description: "Circuit Breaker to prevent cascade failures"
        is_default: false
        keywords:
          - circuit breaker
          - cortocircuito
          - breaker
          - fail fast
        
        # NO requires - can apply to any existing adapter
        
        implementations:
          - id: java-spring-resilience4j
            module: mod-code-001-circuit-breaker-java-resilience4j
            stack: java-spring
            pattern: annotation
        
        default: java-spring-resilience4j

      retry:
        description: "Retry with exponential backoff"
        is_default: false
        keywords:
          - retry
          - reintento
          - backoff
          - exponential backoff
        
        implementations:
          - id: java-spring-resilience4j
            module: mod-code-002-retry-java-resilience4j
            stack: java-spring
            pattern: annotation
        
        default: java-spring-resilience4j

      timeout:
        description: "Timeout to limit wait times"
        is_default: false
        keywords:
          - timeout
          - tiempo límite
          - time limit
          - deadline
        
        implementations:
          - id: java-spring-annotation
            module: mod-code-003-timeout-java-resilience4j
            stack: java-spring
            pattern: annotation
            description: "@TimeLimiter from Resilience4j"
        
        default: java-spring-annotation

      rate-limiter:
        description: "Rate Limiter to control request throughput"
        is_default: false
        keywords:
          - rate limit
          - rate limiter
          - throttling
          - límite de tasa
          - control de tráfico
        
        implementations:
          - id: java-spring-resilience4j
            module: mod-code-004-rate-limiter-java-resilience4j
            stack: java-spring
            pattern: annotation
        
        default: java-spring-resilience4j

  # ─────────────────────────────────────────────────────────────────────────────
  # DISTRIBUTED-TRANSACTIONS (cross-cutting)
  # Patterns for handling distributed transactions
  # ─────────────────────────────────────────────────────────────────────────────
  distributed-transactions:
    description: "Patterns for handling distributed transactions"
    type: cross-cutting
    phase_group: cross-cutting
    cardinality: multiple
    transformable: true
    documentation: "model/domains/code/capabilities/distributed_transactions.md"
    
    keywords:
      - saga
      - distributed transaction
      - transacción distribuida
      - eventual consistency
      - consistencia eventual
    
    # NO default_feature - user must specify
    # NO requires foundational - can apply to existing code
    
    features:
      saga-compensation:
        description: "SAGA pattern with compensation for rollback"
        is_default: false
        keywords:
          - compensation
          - compensación
          - saga
          - rollback
          - undo
        
        implementations:
          - id: java-spring
            module: mod-code-020-compensation-java-spring
            stack: java-spring
        
        default: java-spring

# ═══════════════════════════════════════════════════════════════════════════════
# FUTURE CAPABILITIES (Placeholders)
# ═══════════════════════════════════════════════════════════════════════════════

  # caching:
  #   description: "Caching strategies"
  #   type: compositional
  #   features:
  #     redis:
  #       keywords: [Redis, distributed cache]
  #     local:
  #       keywords: [local cache, Caffeine, in-memory]

  # security:
  #   description: "Security patterns"
  #   type: compositional
  #   features:
  #     oauth2:
  #       keywords: [OAuth2, JWT, authentication]
  #     api-key:
  #       keywords: [API key, authentication]

  # observability:
  #   description: "Observability and monitoring"
  #   type: compositional
  #   features:
  #     metrics:
  #       keywords: [metrics, Prometheus, Micrometer]
  #     tracing:
  #       keywords: [tracing, OpenTelemetry, Jaeger]

# ═══════════════════════════════════════════════════════════════════════════════
# MODULE SUMMARY
# ═══════════════════════════════════════════════════════════════════════════════
#
# Current modules (java-spring):
#   mod-code-001-circuit-breaker-java-resilience4j
#   mod-code-002-retry-java-resilience4j
#   mod-code-003-timeout-java-resilience4j
#   mod-code-004-rate-limiter-java-resilience4j
#   mod-code-015-hexagonal-base-java-spring
#   mod-code-016-persistence-jpa-spring
#   mod-code-017-persistence-systemapi
#   mod-code-018-api-integration-rest-java-spring
#   mod-code-019-api-public-exposure-java-spring
#   mod-code-020-compensation-java-spring
#
# ═══════════════════════════════════════════════════════════════════════════════
