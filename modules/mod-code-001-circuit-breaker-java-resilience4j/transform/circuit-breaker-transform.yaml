# ═══════════════════════════════════════════════════════════════════════════════
# Transform Descriptor: circuit-breaker-transform.yaml
# Module: mod-code-001-circuit-breaker-java-resilience4j
# ═══════════════════════════════════════════════════════════════════════════════
# Type: ANNOTATION TRANSFORMATION
# Target: Adapter classes that call external services (generated by mod-017)
# Purpose: Add @CircuitBreaker annotations and fallback methods
# ═══════════════════════════════════════════════════════════════════════════════
# 
# This descriptor defines HOW to transform existing code to add circuit breaker
# resilience. It is executed in Phase 3 (CROSS-CUTTING) of code generation.
#
# Variables available from context:
#   {{serviceName}}     - e.g., "partiesApi" 
#   {{entityName}}      - e.g., "Customer"
#   {{basePackage}}     - e.g., "com.bank.customer"
# ═══════════════════════════════════════════════════════════════════════════════

transformation:
  id: circuit-breaker-annotation-transform
  type: annotation
  phase: 3
  description: "Add @CircuitBreaker annotations to external service calls"
  
  # ─────────────────────────────────────────────────────────────────────────────
  # TARGET SELECTION
  # ─────────────────────────────────────────────────────────────────────────────
  targets:
    - pattern: "**/adapter/out/**/*Adapter.java"
      description: "Output adapters that call external systems"
      generated_by: 
        - mod-code-017-persistence-systemapi
      exclude:
        - "**/adapter/out/persistence/**"  # JPA adapters don't need circuit breaker
      
  # ─────────────────────────────────────────────────────────────────────────────
  # TRANSFORMATIONS TO APPLY
  # ─────────────────────────────────────────────────────────────────────────────
  steps:
    
    # Step 1: Add imports
    - action: add_imports
      imports:
        - "io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker"
      position: after_package
      deduplicate: true
      
    # Step 2: Add SERVICE_NAME constant (if not exists)
    - action: add_constant
      condition: "not_exists:SERVICE_NAME"
      snippet: snippets/service-name-constant.java
      position: first_in_class
      variables:
        serviceName: "{{serviceName}}"
        
    # Step 3: Add @CircuitBreaker to public methods that call external services
    - action: add_annotation_to_methods
      selector:
        visibility: public
        returns_not: void  # Skip void methods for now (delete operations)
        has_body: true     # Must have implementation
      annotation:
        template: "@CircuitBreaker(name = SERVICE_NAME, fallbackMethod = \"{{methodName}}Fallback\")"
      position: before_existing_annotations
      
    # Step 4: Add fallback methods for each annotated method
    - action: add_fallback_methods
      for_each: annotated_method
      snippet: snippets/fallback-method.java
      position: after_annotated_method
      variables:
        # Inherited from annotated method:
        # - methodName, returnType, parameters, parameterNames
        fallbackStrategy: "return_null"  # Options: return_null, return_empty, throw_wrapped
        
  # ─────────────────────────────────────────────────────────────────────────────
  # YAML CONFIGURATION TO MERGE
  # ─────────────────────────────────────────────────────────────────────────────
  yaml_merge:
    file: "src/main/resources/application.yml"
    template: "../templates/config/application-circuitbreaker.yml.tpl"
    merge_strategy: deep_merge
    path: "resilience4j.circuitbreaker"
    variables:
      serviceName: "{{serviceName}}"
      failureRateThreshold: 50
      waitDurationInOpenState: "30s"
      slidingWindowSize: 10
      
  # ─────────────────────────────────────────────────────────────────────────────
  # POM DEPENDENCIES
  # ─────────────────────────────────────────────────────────────────────────────
  pom_dependencies:
    - groupId: io.github.resilience4j
      artifactId: resilience4j-spring-boot3
      version: "${resilience4j.version}"
    - groupId: org.springframework.boot
      artifactId: spring-boot-starter-aop
      comment: "Required for @CircuitBreaker annotation processing"
      
  pom_properties:
    - name: resilience4j.version
      value: "2.2.0"
      
  # ─────────────────────────────────────────────────────────────────────────────
  # VALIDATION FINGERPRINTS
  # ─────────────────────────────────────────────────────────────────────────────
  # These patterns are checked by tier-0 conformance validation
  fingerprints:
    - pattern: "@CircuitBreaker"
      file: "*Adapter.java"
      description: "Circuit breaker annotation present"
    - pattern: "SERVICE_NAME"
      file: "*Adapter.java"
      description: "Service name constant defined"
    - pattern: "Fallback.*Throwable"
      file: "*Adapter.java"
      description: "Fallback method with Throwable parameter"
