# ═══════════════════════════════════════════════════════════════════════════════
# Transform Descriptor: timeout-config-transform.yaml
# Module: mod-code-003-timeout-java-resilience4j
# Variant: client-timeout (sync) - DEFAULT
# ═══════════════════════════════════════════════════════════════════════════════
# Type: MODIFICATION TRANSFORMATION
# Target: RestClientConfig.java generated by mod-017 or mod-018
# Purpose: Modify HTTP client timeout values from infrastructure (30s/60s) to
#          resilience-level values (e.g., 5s/10s) as defined in DEC-028.
# ═══════════════════════════════════════════════════════════════════════════════
#
# Two-layer timeout model (DEC-028):
#   Phase 2: mod-017/018 generates RestClientConfig with HIGH defaults (30s/60s)
#            → Infrastructure protection against infinite hangs
#   Phase 3: mod-003 TRANSFORMS those values to resilience-level (5s/10s)
#            → Controlled fault tolerance
#
# Variables available from context:
#   {{connectTimeout}}  - e.g., "5" (seconds)
#   {{readTimeout}}     - e.g., "10" (seconds)
#   {{serviceName}}     - e.g., "customerSystemApi"
# ═══════════════════════════════════════════════════════════════════════════════

transformation:
  id: timeout-client-config-transform
  type: modification
  phase: 3
  description: "Modify HTTP client timeouts from infrastructure defaults (30s/60s) to resilience values"

  # ─────────────────────────────────────────────────────────────────────────────
  # TARGET SELECTION
  # ─────────────────────────────────────────────────────────────────────────────
  targets:
    - pattern: "**/infrastructure/config/RestClientConfig.java"
      description: "RestClient configuration with timeout settings"
      generated_by:
        - mod-code-017-persistence-systemapi
        - mod-code-018-api-integration-rest-java-spring

  # ─────────────────────────────────────────────────────────────────────────────
  # TRANSFORMATION STEPS
  # ─────────────────────────────────────────────────────────────────────────────
  steps:

    # Step 1: Replace connect timeout @Value annotation
    - action: replace_annotation_value
      target: "connectTimeout field"
      old_pattern: '@Value("${integration.http.connect-timeout:30s}")'
      new_value: '@Value("${integration.timeout.connect:{{connectTimeout}}s}")'
      description: "Change connect timeout from infrastructure default (30s) to resilience value"

    # Step 2: Replace read timeout @Value annotation
    - action: replace_annotation_value
      target: "readTimeout field"
      old_pattern: '@Value("${integration.http.read-timeout:60s}")'
      new_value: '@Value("${integration.timeout.read:{{readTimeout}}s}")'
      description: "Change read timeout from infrastructure default (60s) to resilience value"

  # ─────────────────────────────────────────────────────────────────────────────
  # YAML CONFIGURATION TO MERGE
  # ─────────────────────────────────────────────────────────────────────────────
  yaml_merge:
    file: "src/main/resources/application.yml"
    merge_strategy: deep_merge
    path: "integration.timeout"
    content: |
      integration:
        timeout:
          connect: {{connectTimeout}}s
          read: {{readTimeout}}s

  # ─────────────────────────────────────────────────────────────────────────────
  # VALIDATION FINGERPRINTS
  # ─────────────────────────────────────────────────────────────────────────────
  fingerprints:
    - pattern: "integration.timeout.connect"
      file: "application.yml"
      description: "Resilience timeout connect value configured"
    - pattern: "integration.timeout.read"
      file: "application.yml"
      description: "Resilience timeout read value configured"
